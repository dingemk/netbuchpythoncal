<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>net-schulbuch-python (Monaco + Pyodide + Turtle)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="styles.css" rel="stylesheet" />

  <!-- Monaco + Pyodide + Turtle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
  <script src="turtle.js"></script>
</head>

<body>
  <!-- Topbar -->
  <nav class="navbar navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <span class="navbar-brand mb-0 h1">net-schulbuch-python</span>
        <span class="badge bg-secondary ms-2">Calliope: <span id="calliope-target">1/2</span></span>
      </div>

      <div class="run-icon-center">
        <span class="run-icon" id="run-icon" title="Programm ausfÃ¼hren (Shift+Enter)">â–¶</span>
        <button id="emergency-reset-btn" class="btn btn-danger btn-sm ms-2" title="Notfall-Reset" type="button">ğŸ”„</button>
      </div>

      <div class="d-flex gap-2">
        <button id="save-png-btn" class="btn btn-info btn-sm text-white" disabled type="button">ğŸ“‹ Bild kopieren</button>
        <a class="btn btn-outline-primary btn-sm" id="btn-serial-upload" href="#">â¬†ï¸ Seriell hochladen (main.py)</a>

        <!-- Clear-Dropdown -->
        <div class="dropdown" id="clear-dropdown">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="clear-dropdown-btn" aria-expanded="false">LÃ¶schen â–¼</button>
          <div class="dropdown-menu" id="clear-dropdown-menu" role="menu">
            <a class="dropdown-item" href="#" id="clear-editor-btn" role="menuitem">Editor lÃ¶schen</a>
            <a class="dropdown-item" href="#" id="clear-canvas-btn" role="menuitem">Leinwand lÃ¶schen</a>
            <a class="dropdown-item" href="#" id="clear-output-btn" role="menuitem">Ausgabe lÃ¶schen</a>
          </div>
        </div>

        <!-- Hamburger-MenÃ¼ -->
        <div class="dropdown" id="hamburger-dropdown">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="hamburger-btn" aria-expanded="false">â˜°</button>
          <div class="dropdown-menu dropdown-menu-end" id="hamburger-menu" style="min-width:240px;" role="menu">
            <a class="dropdown-item" href="#" id="load-program-btn" role="menuitem">Programm laden</a>
            <a class="dropdown-item" href="#" id="save-program-btn" role="menuitem">Programm speichern</a>
            <a class="dropdown-item" href="#" id="examples-btn" role="menuitem">ğŸ“š Beispiele</a>
            <a class="dropdown-item" href="#" id="licenses-btn" role="menuitem">ğŸ“„ Lizenzen</a>
            <a class="dropdown-item" href="#" id="impressum-btn" role="menuitem">ğŸ¢ Impressum</a>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Dateien</div>
            <label for="file-input" class="dropdown-item" style="cursor:pointer;">
              <input id="file-input" type="file" class="visually-hidden" multiple />
              ğŸ“ Dateien hochladen
            </label>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Layout</div>
            <a class="dropdown-item" href="#" id="layout-canvas-output" role="menuitem">Canvas + Output</a>
            <a class="dropdown-item" href="#" id="layout-output-files" role="menuitem">Output + Dateien</a>
            <a class="dropdown-item" href="#" id="layout-canvas-output-files" role="menuitem">Canvas + Output + Dateien</a>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Calliope / MicroPython</div>
            <a class="dropdown-item" href="#"
               onclick="CalliopeHex?.setTargetC12(); document.getElementById('calliope-target').textContent='1/2'; return false;">
              Ziel: Calliope 1/2 (<code>import calliope_mini</code>)
            </a>
            <a class="dropdown-item" href="#"
               onclick="CalliopeHex?.setTargetC3(); document.getElementById('calliope-target').textContent='3'; return false;">
              Ziel: Calliope 3 (<code>import calliopemini</code>)
            </a>
            <a class="dropdown-item" href="#" onclick="CalliopeHex?.buildAndDownload(); return false;">â¬‡ï¸ main.hex herunterladen</a>
            <a class="dropdown-item" href="#" onclick="CalliopeHex?.buildAndSaveToDrive(); return false;">ğŸ’½ main.hex aufs Laufwerk</a>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Serielle Verbindung</div>
            <!-- FIX: konsistente ID 'btn-serial-connect' -->
            <a class="dropdown-item" id="btn-serial-connect" href="#">ğŸ”Œ Verbinden</a>
            <a class="dropdown-item" id="btn-serial-close" href="#">âŒ Trennen</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hauptbereich -->
  <div id="workarea">
    <div id="left">
      <div id="editor"></div>
    </div>
    <div id="resizer" role="separator" aria-orientation="vertical" aria-label="GrÃ¶ÃŸenanpassung"></div>
    <div id="right">
      <div id="canvas-wrap"><canvas id="canvas" width="900" height="540"></canvas></div>
      <div id="resizer-h" role="separator" aria-orientation="horizontal" aria-label="GrÃ¶ÃŸenanpassung"></div>
      <div id="output"></div>
      <div id="files-panel" style="display:none;">
        <div class="p-3">
          <h6>Hochgeladene Dateien:</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Pfad</th>
                <th class="text-end">GrÃ¶ÃŸe</th>
                <th>Typ</th>
                <th class="text-center">Aktion</th>
              </tr>
            </thead>
            <tbody id="files-tbody">
              <tr>
                <td colspan="4"><em>Lade...</em></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- micro:bit Tools â€“ erst lokal, dann Fallback CDN -->
  <!-- <script src="vendor/nrf-intel-hex.umd.js"></script> -->
  <script src="vendor/microbit-fs/dist/microbit-fs.umd.js"></script>
  <script>
  (function () {
    // UMD kann unter MicrobitFs, microbit-fs oder als default exportiert sein
    var c = window.MicrobitFs || window.microbitFs || window['microbit-fs'] || null;
    if (c && c.default) c = c.default;
    if (c) {
      window.MicrobitFs = c;  // <- von calliope.hex.js benutzt
      window.microbitFs = c;  // zusÃ¤tzlicher Alias
    } else {
      console.error('microbit-fs UMD nicht geladen â€“ Pfad prÃ¼fen.');
    }
  })();
</script>

  <!-- Calliope Builder & Serial -->
 <!-- Calliope Builder & Serial -->
<script src="calliope.hex.js"></script>
<script src="calliope.serial.js"></script>

<script>
  // Editor-Inhalt robust abholen (Textarea / Monaco / CodeMirror)
  function getEditorCode() {
    try { if (window.editor?.getValue) return String(window.editor.getValue()); } catch (e) {}
    try { if (window.cmEditor?.getValue) return String(window.cmEditor.getValue()); } catch (e) {}
    const ta = document.querySelector('#editor, textarea[name="code"], textarea[data-role="editor"]');
    return ta ? String(ta.value || '') : '';
  }

  // HEX-Builder initialisieren â€“ fester Pfad in /firmware
  (function initHex() {
    if (!window.CalliopeHex) { setTimeout(initHex, 80); return; }

    // Optionaler Reachability-Check per GET (manche Dev-Server 404en auf HEAD)
    fetch('firmware/micro_bit.hex', { method: 'GET', cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('firmware/micro_bit.hex nicht erreichbar');
    CalliopeHex.init({
  outEl: document.getElementById('output'),
  firmwareUrls: {
    c12: 'firmware/micro_bit.hex'  // oder calliope12-micropython.hex
  }
});
      })
      .catch(err => {
        document.getElementById('output')?.insertAdjacentHTML(
          'beforeend',
          `<div class="text-danger">âŒ ${err.message}</div>`
        );
        console.error(err);
      });
  })();

  // Serielle Tools initialisieren und Buttons verdrahten
  (function initSerial() {
    if (!window.CalliopeSerial) { setTimeout(initSerial, 80); return; }
    CalliopeSerial.init({
      editor: { getValue: getEditorCode },
      outEl: document.getElementById('output')
    });

    document.getElementById('btn-serial-connect')?.addEventListener('click', (e) => {
      e.preventDefault(); CalliopeSerial.openSerial();
    });
    document.getElementById('btn-serial-close')?.addEventListener('click', (e) => {
      e.preventDefault(); CalliopeSerial.closeSerial();
    });
    document.getElementById('btn-serial-upload')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const code = getEditorCode();
      if (!/\S/.test(code)) { alert('Kein Code im Editor.'); return; }
      await CalliopeSerial.uploadMainPyViaSerial(code);
    });
    document.getElementById('btn-serial-run')?.addEventListener('click', (e) => {
      e.preventDefault(); CalliopeSerial.runMainModule();
    });
    document.getElementById('btn-list-files')?.addEventListener('click', (e) => {
      e.preventDefault(); CalliopeSerial.listFiles();
    });
  })();
</script>

<!-- WICHTIG: Kein zusÃ¤tzliches </script> hier -->
<script src="scripts.js" defer></script>
</body>
</html>