<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <title>net-schulbuch-python (Monaco + Pyodide + Turtle)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="styles.css" rel="stylesheet" />

  
</head>

<body>
  <!-- Topbar -->
  <nav class="navbar navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <span class="navbar-brand mb-0 h1">net-schulbuch-python</span>
      </div>

      <div class="run-icon-center d-flex align-items-center gap-2">
        <span class="run-icon" id="run-icon" title="Programm ausf√ºhren (Shift+Enter)">‚ñ∂</span>
        <button id="emergency-reset-btn" class="btn btn-danger btn-sm" title="Notfall-Reset" type="button">üîÑ</button>

        <!-- NEU: direkt daneben -->
        <button id="connect-toggle-btn" class="btn btn-outline-secondary btn-sm hidden" type="button"
          title="Verbinden">üîå Verbinden</button>

        <button id="flash-btn" class="btn btn-warning btn-sm hidden" type="button" title="Flash (main.hex auf Ger√§t)">‚ö°
          Flash</button>
      </div>

      <div class="d-flex gap-2">
        <button id="save-png-btn" class="btn btn-info btn-sm text-white" disabled type="button">üìã Bild
          kopieren</button>
        <!-- Clear-Dropdown -->
        <div class="dropdown" id="clear-dropdown">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="clear-dropdown-btn" aria-expanded="false">L√∂schen ‚ñº</button>
          <div class="dropdown-menu" id="clear-dropdown-menu" role="menu">
            <a class="dropdown-item" href="#" id="clear-editor-btn" role="menuitem">Editor l√∂schen</a>
            <a class="dropdown-item" href="#" id="clear-canvas-btn" role="menuitem">Leinwand l√∂schen</a>
            <a class="dropdown-item" href="#" id="clear-output-btn" role="menuitem">Ausgabe l√∂schen</a>
          </div>
        </div>

        <!-- Hamburger-Men√º -->
        <div class="dropdown" id="hamburger-dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="hamburger-btn"
            data-bs-toggle="dropdown"  aria-expanded="false">‚ò∞</button>

          <div class="dropdown-menu dropdown-menu-end" id="hamburger-menu" role="menu" style="min-width:240px;"
            aria-labelledby="hamburger-btn" >
            <a class="dropdown-item" href="#" id="load-program-btn" role="menuitem">Programm laden</a>
            <a class="dropdown-item" href="#" id="save-program-btn" role="menuitem">Programm speichern</a>

            <!-- Modal-Trigger bleibt so: -->
            <a class="dropdown-item" href="#" id="examples-btn" role="menuitem" data-bs-toggle="modal"
              data-bs-target="#examplesModal">üìö Beispiele</a>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Dateien</div>
            <label for="file-input" class="dropdown-item" style="cursor:pointer;">
              <input id="file-input" type="file" class="visually-hidden" multiple />
              üìÅ Dateien hochladen
            </label>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Layout</div>
            <div class="px-3 py-2">
              <select id="layout-select" class="form-select form-select-sm">
                <option value="canvas-output" selected>Canvas + Output</option>
                <option value="output-files">Output + Dateien</option>
                <option value="canvas-output-files">Canvas + Output + Dateien</option>
              </select>
            </div>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Hardware</div>
            <div class="px-3 py-2">
              <select id="device-select" class="form-select form-select-sm">
                <option value="none" selected>-</option>
                <option value="c12">Calliope mini 1/2</option>
                <option value="c3">Calliope mini 3</option>
              </select>
            </div>

            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" id="licenses-btn" role="menuitem">üìÑ Lizenzen</a>
            <a class="dropdown-item" href="#" id="impressum-btn" role="menuitem">üè¢ Impressum</a>
          </div>
        </div>
  </nav>

  <!-- Hauptbereich -->
  <div id="workarea">
    <div id="left">
      <div id="editor"></div>
    </div>
    <div id="resizer" role="separator" aria-orientation="vertical" aria-label="Gr√∂√üenanpassung"></div>
    <div id="right">
      <div id="canvas-wrap"><canvas id="canvas" width="900" height="540"></canvas></div>
      <div id="resizer-h" role="separator" aria-orientation="horizontal" aria-label="Gr√∂√üenanpassung"></div>
      <div id="output"></div>
      <div id="files-panel" style="display:none;">
        <div class="p-3">
          <h6>Hochgeladene Dateien:</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Pfad</th>
                <th class="text-end">Gr√∂√üe</th>
                <th>Typ</th>
                <th class="text-center">Aktion</th>
              </tr>
            </thead>
            <tbody id="files-tbody">
              <tr>
                <td colspan="4"><em>Lade...</em></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal f√ºr Beispiele -->
  <div class="modal fade" id="examplesModal" tabindex="-1" aria-labelledby="examplesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="examplesModalLabel">üìö Turtle-Beispiele</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row" id="examples-grid">
            <!-- Beispiele werden hier dynamisch eingef√ºgt -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
          <button type="button" class="btn btn-primary" id="load-example-btn" disabled>Programm laden</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal f√ºr Lizenzen -->
  <div class="modal fade" id="licensesModal" tabindex="-1" aria-labelledby="licensesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="licensesModalLabel">üìÑ Lizenzen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="license-section mb-4">
            <h6>üéØ net-schulbuch-python IDE</h6>
            <p><strong>Lizenz:</strong> F√ºr nichtkommerzielle Zwecke kostenlos nutzbar</p>
            <p><strong>Entwickler:</strong> Klaus Dingemann</p>
            <p><strong>Beschreibung:</strong> Eine browserbasierte Python-IDE mit Turtle-Grafik, entwickelt f√ºr den
              Schulunterricht.</p>
          </div>

          <div class="license-section mb-4">
            <h6>üêç Python</h6>
            <p><strong>Lizenz:</strong> Python Software Foundation License (PSF)</p>
            <p><strong>Website:</strong> <a href="https://www.python.org/" target="_blank">https://www.python.org/</a>
            </p>
            <p><strong>Beschreibung:</strong> Python ist eine Programmiersprache, die in dieser IDE √ºber Pyodide
              ausgef√ºhrt wird.</p>
          </div>

          <div class="license-section mb-4">
            <h6>‚ö° Pyodide</h6>
            <p><strong>Lizenz:</strong> Mozilla Public License 2.0 (MPL 2.0)</p>
            <p><strong>Website:</strong> <a href="https://pyodide.org/" target="_blank">https://pyodide.org/</a></p>
            <p><strong>Beschreibung:</strong> Pyodide ist eine Python-Distribution f√ºr den Browser, die CPython zu
              WebAssembly kompiliert.</p>
          </div>

          <div class="license-section mb-4">
            <h6>üìù Monaco Editor</h6>
            <p><strong>Lizenz:</strong> MIT License</p>
            <p><strong>Website:</strong> <a href="https://microsoft.github.io/monaco-editor/"
                target="_blank">https://microsoft.github.io/monaco-editor/</a></p>
            <p><strong>Beschreibung:</strong> Monaco Editor ist der Code-Editor, der in Visual Studio Code verwendet
              wird.</p>
          </div>

          <div class="license-section mb-4">
            <h6>üé® Bootstrap</h6>
            <p><strong>Lizenz:</strong> MIT License</p>
            <p><strong>Website:</strong> <a href="https://getbootstrap.com/"
                target="_blank">https://getbootstrap.com/</a></p>
            <p><strong>Beschreibung:</strong> Bootstrap ist ein CSS-Framework f√ºr responsive Webdesign.</p>
          </div>

          <div class="license-section mb-4">
            <h6>üìä Python-Bibliotheken</h6>
            <p><strong>pandas:</strong> BSD 3-Clause License</p>
            <p><strong>numpy:</strong> BSD 3-Clause License</p>
            <p><strong>matplotlib:</strong> Python Software Foundation License (PSF)</p>
            <p><strong>micropip:</strong> Mozilla Public License 2.0 (MPL 2.0)</p>
            <p><strong>Beschreibung:</strong> Diese Bibliotheken werden √ºber Pyodide geladen und sind f√ºr die
              Datenverarbeitung und Visualisierung verf√ºgbar.</p>
          </div>

          <div class="license-section mb-4">
            <h6>üîí Nutzungsbedingungen</h6>
            <p><strong>Nichtkommerzielle Nutzung:</strong> Diese Software darf f√ºr Bildungszwecke, private Projekte und
              nichtkommerzielle Anwendungen kostenlos genutzt werden.</p>
            <p><strong>Kommerzielle Nutzung:</strong> F√ºr kommerzielle Zwecke ist eine separate Lizenzvereinbarung
              erforderlich.</p>
            <p><strong>Haftungsausschluss:</strong> Die Software wird "wie besehen" bereitgestellt, ohne Gew√§hrleistung
              jeglicher Art.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal f√ºr Impressum -->
  <div class="modal fade" id="impressumModal" tabindex="-1" aria-labelledby="impressumModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="impressumModalLabel">üè¢ Impressum</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="impressum-section mb-4">
            <h6>üè¢ Unternehmensangaben</h6>
            <p><strong>Firmenname:</strong> net-schulbuch.de gemeinn√ºtzige UG (haftungsbeschr√§nkt)</p>
            <p><strong>Adresse:</strong> Poststra√üe 38<br>49477 Ibbenb√ºren</p>
            <p><strong>Telefon:</strong> <a href="tel:+491712672373">+49 171 267 23 73</a></p>
            <p><strong>E-Mail:</strong> <a href="mailto:info@net-schulbuch.de">info@net-schulbuch.de</a></p>
            <p><strong>Internet:</strong> <a href="https://www.net-schulbuch.de"
                target="_blank">www.net-schulbuch.de</a></p>
          </div>

          <div class="impressum-section mb-4">
            <h6>üìã Rechtsform</h6>
            <p>NET-Schulbuch.de ist eine gemeinn√ºtzige Unternehmergesellschaft - gUG (haftungsbeschr√§nkt) nach dem GmbHG
              vom 1. November 2008</p>
            <p><strong>Gesch√§ftsf√ºhrer der Gesellschaft ist Berthold Hufnagel</strong><br>
              E-Mail: <a href="mailto:hufnagel@net-schulbuch.de">hufnagel@net-schulbuch.de</a></p>
          </div>

          <div class="impressum-section mb-4">
            <h6>üêõ Fehlermeldungen</h6>
            <p>Fehlermeldungen bitte an: <a href="mailto:klaus@dingemann.de">klaus@dingemann.de</a></p>
          </div>

          <div class="impressum-section mb-4">
            <h6>üìö Unsere digitalen Schulb√ºcher</h6>
            <p>Wir empfehlen unsere digitalen Schulb√ºcher f√ºr den Mathematik- und Informatikunterricht:</p>
            <ul>
              <li><strong>Informatik 5/6</strong> (als Schulbuch in NRW genehmigt) - <a
                  href="https://if56.net-schulbuch.de" target="_blank">https://if56.net-schulbuch.de</a></li>
              <li><strong>Informatik S I</strong> - <a href="https://if2.net-schulbuch.de"
                  target="_blank">https://if2.net-schulbuch.de</a></li>
              <li><strong>Mathematik S I</strong> - <a href="https://m2.net-schulbuch.de"
                  target="_blank">https://m2.net-schulbuch.de</a></li>
              <li><strong>Informatik S I Wahlpflichtbereich</strong> - <a href="https://ifwp.net-schulbuch.de"
                  target="_blank">https://ifwp.net-schulbuch.de</a></li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS -->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>-->
<script>
  (function loadBootstrapBundle() {
    function add(src, label) {
      var s = document.createElement('script');
      s.src = src;
      s.async = false;            // Reihenfolge garantieren
      s.onload  = function(){ console.log('[boot] OK:', label, 'typeof bootstrap =', typeof window.bootstrap); };
      s.onerror = function(){ console.warn('[boot] FAIL:', label); };
      document.head.appendChild(s);
      return s;
    }
    // 1) lokal (falls du sie ablegst unter vendor/bootstrap.bundle.min.js), sonst √ºberspringen
    // var local = add('vendor/bootstrap.bundle.min.js', 'local');
    // local.onerror = function () {

    // 2) CDN-Kette
    var a = add('https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'jsDelivr');
    a.onerror = function () {
      var b = add('https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js', 'cdnjs');
      b.onerror = function () {
        add('https://unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'unpkg');
      };
    };
    // }; // <- falls du die lokale Zeile oben aktivierst, diese Klammern/Kommentar beachten
  })();
</script>
!-- Monaco + Pyodide + Turtle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
  <script src="turtle.js"></script>
  <!-- micro:bit Tools ‚Äì erst lokal, dann Fallback CDN (nur UMD der FS-Lib) -->
  <script src="vendor/microbit-fs/dist/microbit-fs.umd.js"></script>
  <script>
    (function () {
      // UMD kann unter MicrobitFs, microbit-fs oder als default exportiert sein
      var c = window.MicrobitFs || window.microbitFs || window['microbit-fs'] || null;
      if (c && c.default) c = c.default;
      if (c) {
        window.MicrobitFs = c;  // <- von calliope.hex.js benutzt
        window.microbitFs = c;  // zus√§tzlicher Alias
      } else {
        console.error('microbit-fs UMD nicht geladen ‚Äì Pfad pr√ºfen.');
      }
    })();
  </script>

  <!-- Calliope HEX Tools (ES-Modul, setzt zus√§tzlich window.calliopeHexTools) -->
  <script type="module" src="calliope-hex-tools.js"></script>

  <!-- Calliope Builder & Serial -->
  <script src="calliope.hex.js"></script>
  <script src="calliope.serial.js"></script>

  <script>
    (function topbarButtons() {
      const outEl = document.getElementById('output');
      const connectBtn = document.getElementById('connect-toggle-btn');
      const flashBtn = document.getElementById('flash-btn');
      if (!connectBtn || !flashBtn) return;

      const log = (m, cls = 'text-muted') => {
        outEl?.insertAdjacentHTML('beforeend', `<div class="${cls}">${m}</div>`);
        outEl?.scrollTo?.(0, outEl.scrollHeight);
      };

      function resolveTarget() {
        if (window.CalliopeHex?.getTarget) {
          const t = CalliopeHex.getTarget();
          if (t) return t; // 'c12' | 'c3'
        }
        const rb = document.querySelector('input[name="hwTarget"]:checked');
        if (rb && (rb.value === 'c12' || rb.value === 'c3')) return rb.value;
        return 'c12';
      }

      let connected = false;
      let c12ReconnectSession = null;
      function updateConnectUI() {
        if (connected) {
          connectBtn.classList.remove('btn-outline-secondary');
          connectBtn.classList.add('btn-success');
          connectBtn.textContent = 'üü¢ Trennen';
          connectBtn.title = 'Verbindung trennen';
        } else {
          connectBtn.classList.remove('btn-success');
          connectBtn.classList.add('btn-outline-secondary');
          connectBtn.textContent = 'üîå Verbinden';
          connectBtn.title = 'Mit Calliope verbinden';
        }
      }

      // Verbinden/Trennen
      connectBtn.addEventListener('click', async () => {
        if (!window.CalliopeSerial) { log('‚ùå CalliopeSerial nicht geladen.', 'text-danger'); return; }
        try {
          if (!connected) { await CalliopeSerial.openSerial(); connected = true; }
          else { await CalliopeSerial.closeSerial(); connected = false; }
        } catch (e) { log(`‚ùå ${e?.message || e}`, 'text-danger'); }
        updateConnectUI();
      });

      navigator.serial?.addEventListener?.('disconnect', () => { connected = false; updateConnectUI(); });

      // Bonus: wenn das Ger√§t neu enumeriert, sofort versuchen (ohne Dialog) zu √∂ffnen
      navigator.serial?.addEventListener?.('connect', async () => {
        if (!window.CalliopeSerial?.tryOpenGranted) return;
        try {
          const ok = await CalliopeSerial.tryOpenGranted();
          if (ok) { connected = true; updateConnectUI(); }
        } catch { }
      });

      // Flash-Button
      flashBtn.addEventListener('click', async () => {
        const target = resolveTarget();
        try {
          if (target === 'c12') {
            // 1) HEX bauen & downloaden
            await CalliopeHex.buildAndDownload();

            // 2) Auto-Reconnect ohne Dialog ‚Äì Sessionsafe
            if (!window.CalliopeSerial?.tryOpenGranted) {
              log('‚ÑπÔ∏è Auto-Reconnect nicht verf√ºgbar (tryOpenGranted fehlt).', 'text-muted');
              return;
            }

            // neue Session starten, √§ltere invalidieren
            const mySession = Symbol('c12-reconnect');
            c12ReconnectSession = mySession;

            log('‚è≥ Warte auf Ger√§t ‚Ä¶ automatische Wiederverbindung bis zu 20s ‚Ä¶');

            const startDelayMs = 3000;   // erster Versuch nach 3s
            const windowMs = 20000;  // insgesamt 20s
            const startTs = Date.now();

            let timerId = null;

            function isStale() {
              return c12ReconnectSession !== mySession; // ein neuer Versuch hat uns √ºberholt
            }
            function cleanup() {
              if (timerId) { clearTimeout(timerId); timerId = null; }
              navigator.serial?.removeEventListener?.('connect', onConnectEvent);
            }

            async function success() {
              if (isStale()) return;
              connected = true; updateConnectUI();
              log('‚úÖ Serielle Verbindung wiederhergestellt.');
              cleanup();
            }

            // Wenn das System ‚Äûconnect‚Äú meldet, sofort probieren (ohne Dialog)
            async function onConnectEvent() {
              if (isStale()) return;
              try {
                const ok = await CalliopeSerial.tryOpenGranted();
                if (ok) await success();
              } catch { }
            }
            navigator.serial?.addEventListener?.('connect', onConnectEvent);

            const attempt = async () => {
              if (isStale()) return; // neuer Versuch gestartet ‚Üí diesen abbrechen
              if (Date.now() - startTs > windowMs) {
                cleanup();
                if (!isStale()) { // nur loggen, wenn wir noch die aktive Session sind
                  log('‚åõÔ∏è Kein Auto-Reconnect m√∂glich. Bitte ‚Äûüîå Verbinden‚Äú klicken.', 'text-warning');
                }
                return;
              }
              try {
                const ok = await CalliopeSerial.tryOpenGranted(); // √∂ffnet nur freigegebene Ports
                if (ok) { await success(); return; }
              } catch { }
              timerId = setTimeout(attempt, 1000); // alle 1s erneut
            };

            // erster Versuch nach 3s
            timerId = setTimeout(attempt, startDelayMs);

          } else if (target === 'c3') {
            window.CalliopeSerial?.expectReset?.(20000);
            await CalliopeHex.buildAndSaveToDrive();
          } else {
            log('‚ö†Ô∏è Keine Hardware gew√§hlt.', 'text-warning');
          }
        } catch (e) {
          log(`‚ùå Flash: ${e?.message || e}`, 'text-danger');
        }
      });

      updateConnectUI();
    })();
  </script>

  <script>
    (function deviceSelector() {
      const sel = document.getElementById('device-select');
      const runIcon = document.getElementById('run-icon');
      const resetBtn = document.getElementById('emergency-reset-btn');
      const connectB = document.getElementById('connect-toggle-btn');
      const flashB = document.getElementById('flash-btn');
      const badge = document.getElementById('calliope-target');

      if (!sel || !runIcon || !resetBtn || !connectB || !flashB) return;

      // --- Storage Helpers ---
      const LS_KEY_DEVICE = 'ui.device';
      const LS_KEY_CONN = 'ui.deviceConnected'; // rein informativ ‚Äì WebSerial-Permissions werden NICHT gespeichert

      const saveDevice = (v) => { try { localStorage.setItem(LS_KEY_DEVICE, v); } catch { } };
      const loadDevice = () => { try { return localStorage.getItem(LS_KEY_DEVICE) || null; } catch { return null; } };
      const saveConnFlag = (on) => { try { localStorage.setItem(LS_KEY_CONN, on ? '1' : '0'); } catch { } };

      // --- UI anwenden ---
      function applyUIByDevice(dev) {
        const hwSelected = (dev === 'c12' || dev === 'c3' || dev === 'microbit');

        // Verbinden/Flash sichtbar nur bei Hardware
        connectB.classList.toggle('hidden', !hwSelected);
        flashB.classList.toggle('hidden', !hwSelected);

        // Run/Reset sperren, wenn Hardware benutzt wird
        runIcon.classList.toggle('disabled', hwSelected);
        if (hwSelected) {
          runIcon.setAttribute('aria-disabled', 'true');
          runIcon.title = 'Run im Browser deaktiviert (Hardware aktiv)';
          resetBtn.setAttribute('disabled', 'disabled');
          resetBtn.title = 'Reset im Browser deaktiviert (Hardware aktiv)';
        } else {
          runIcon.removeAttribute('aria-disabled');
          runIcon.title = 'Programm ausf√ºhren (Shift+Enter)';
          resetBtn.removeAttribute('disabled');
          resetBtn.title = 'Notfall-Reset';
        }

        // Badge aktualisieren (Calliope)
        if (badge) {
          if (dev === 'c12') badge.textContent = '1/2';
          else if (dev === 'c3') badge.textContent = '3';
          else badge.textContent = '‚Äì';
        }

        // Target an den Builder melden
        if (window.CalliopeHex) {
          if (dev === 'c12' && CalliopeHex.setTargetC12) CalliopeHex.setTargetC12();
          if (dev === 'c3' && CalliopeHex.setTargetC3) CalliopeHex.setTargetC3();
        }
      }

      // Run-Klick sperren, wenn disabled
      runIcon.addEventListener('click', (e) => {
        if (runIcon.classList.contains('disabled')) { e.preventDefault(); e.stopPropagation(); }
      });

      // --- Auswahlwechsel speichern ---
      sel.addEventListener('change', () => {
        const dev = sel.value; // 'none' | 'c12' | 'c3' | 'microbit'
        saveDevice(dev);
        applyUIByDevice(dev);
      });

      // --- Beim Laden gespeichertes Ger√§t wiederherstellen ---
      (function restoreDeviceOnLoad() {
        const saved = loadDevice();
        if (saved && [...sel.options].some(o => o.value === saved)) {
          sel.value = saved;
        }
        // Falls nichts gespeichert war, aktuellen "selected" Wert verwenden und speichern
        saveDevice(sel.value);
        applyUIByDevice(sel.value);
      })();

      // --- (Optional) Verbunden-Status mitschreiben ---
      // Achtung: Das speichert nur eine Flag ‚Äì Berechtigungen sind Sache des Browsers.
      let connected = false;
      function setConnected(on) {
        connected = !!on;
        saveConnFlag(connected);
        // Knopf-Optik
        if (connected) {
          connectB.classList.remove('btn-outline-secondary');
          connectB.classList.add('btn-success');
          connectB.textContent = 'üü¢ Trennen';
          connectB.title = 'Verbindung trennen';
        } else {
          connectB.classList.remove('btn-success');
          connectB.classList.add('btn-outline-secondary');
          connectB.textContent = 'üîå Verbinden';
          connectB.title = 'Mit Calliope verbinden';
        }
      }

      // Falls dein CalliopeSerial das bereits steuert, kannst du die folgenden Listener weglassen.
      document.getElementById('connect-toggle-btn')?.addEventListener('click', async () => {
        if (!window.CalliopeSerial) return;
        try {
          if (!connected) { await CalliopeSerial.openSerial(); setConnected(true); }
          else { await CalliopeSerial.closeSerial(); setConnected(false); }
        } catch (e) { /* Ausgabe macht schon der andere Code */ }
      });
      navigator.serial?.addEventListener?.('disconnect', () => setConnected(false));
      navigator.serial?.addEventListener?.('connect', async () => {
        // Wenn du tryOpenGranted nutzt, kannst du hier auto-reconnecten
        try {
          if (window.CalliopeSerial?.tryOpenGranted) {
            const ok = await CalliopeSerial.tryOpenGranted();
            if (ok) setConnected(true);
          }
        } catch { }
      });
    })();
  </script>


  <script>
    // Editor-Inhalt robust abholen (Textarea / Monaco / CodeMirror)
    function getEditorCode() {
      try { if (window.editor?.getValue) return String(window.editor.getValue()); } catch (e) { }
      try { if (window.cmEditor?.getValue) return String(window.cmEditor.getValue()); } catch (e) { }
      const ta = document.querySelector('#editor, textarea[name="code"], textarea[data-role="editor"]');
      return ta ? String(ta.value || '') : '';
    }

    // -------- Serielle Verbindung initialisieren + Buttons verdrahten --------
    (function initSerial() {
      if (!window.CalliopeSerial) { setTimeout(initSerial, 80); return; }

      CalliopeSerial.init({
        editor: { getValue: getEditorCode },
        outEl: document.getElementById('output')
      });

      // üîå Verbinden
      document.getElementById('btn-serial-connect')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await CalliopeSerial.openSerial(); }
        catch (err) {
          console.error('Connect-Fehler:', err);
          document.getElementById('output')?.insertAdjacentHTML('beforeend',
            `<div class="text-danger">‚ùå Serial Connect: ${err.message || err}</div>`);
        }
      });

      // ‚ùå Trennen
      document.getElementById('btn-serial-close')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await CalliopeSerial.closeSerial(); } catch (err) { console.error(err); }
      });

      // ‚¨ÜÔ∏è Upload (main.py) + sichtbar ausf√ºhren
      document.getElementById('btn-serial-upload')?.addEventListener('click', async (e) => {
        e.preventDefault();
        const code = getEditorCode();
        if (!/\S/.test(code)) { alert('Kein Code im Editor.'); return; }
        try { await CalliopeSerial.uploadMainPyViaSerial(code); }
        catch (err) { console.error('Upload fehlgeschlagen:', err); }
      });
    })();

    // -------- HEX-Builder initialisieren ‚Äì fester Pfad in /firmware --------
    (function initHex() {
      if (!window.CalliopeHex) { setTimeout(initHex, 80); return; }

      fetch('firmware/micro_bit.hex', { method: 'GET', cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('firmware/micro_bit.hex nicht erreichbar');
          CalliopeHex.init({
            outEl: document.getElementById('output'),
            firmwareUrls: {
              c12: 'firmware/micro_bit.hex'
              // c3:  'firmware/calliope_v3.hex'   // (optional) erg√§nzen, falls vorhanden
            }
          });
        })
        .catch(err => {
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend',
            `<div class="text-danger">‚ùå ${err.message}</div>`
          );
          console.error(err);
        });
    })();

    // -------- Builder-Hook: Editor ‚Üí HEX + Flash mit expectReset --------
    (function hookHexBuilder() {
      if (!window.calliopeHexTools || !window.CalliopeHex) {
        return void setTimeout(hookHexBuilder, 80);
      }

      // Firmware je nach Ziel laden
      async function fetchBaseHex() {
        const urls = CalliopeHex.firmwareUrls || { c12: 'firmware/micro_bit.hex' };
        const target = (CalliopeHex.getTarget && CalliopeHex.getTarget()) || 'c12';
        const url = (target === 'c3' && urls.c3) ? urls.c3 : urls.c12;
        if (!url) throw new Error('Keine Firmware-URL f√ºr aktuelles Ziel.');
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Firmware nicht ladbar: ${url}`);
        return await res.text();
      }

      // Editor ‚Üí HEX-Text
      async function buildHexText() {
        const baseHex = await fetchBaseHex();
        const py = getEditorCode();
        if (!/\S/.test(py)) throw new Error('Kein Python-Code im Editor.');
        // F√ºr C1/2 klassisch anh√§ngen; f√ºr C3 k√∂nnte sp√§ter FS genutzt werden:
        const target = (CalliopeHex.getTarget && CalliopeHex.getTarget()) || 'c12';
        return (target === 'c3')
          ? await calliopeHexTools.packMainPyAuto(baseHex, py, { quiet: true })
          : calliopeHexTools.appendScriptV1(baseHex, py);
      }

      // ‚¨áÔ∏è Download (kein Reset n√∂tig)
      CalliopeHex.buildAndDownload = async function () {
        try {
          const hexText = await buildHexText();
          const blob = new Blob([hexText], { type: 'text/plain' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'main.hex';
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(() => URL.revokeObjectURL(a.href), 4000);
        } catch (e) {
          console.error(e);
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend', `<div class="text-danger">‚ùå ${e.message || e}</div>`
          );
        }
      };

      // üíΩ Aufs Laufwerk (oder Fallback Download) ‚Äî hier Reset ank√ºndigen
      CalliopeHex.buildAndSaveToDrive = async function () {
        try {
          const hexText = await buildHexText();

          // üëâ Neustart-Fenster ank√ºndigen, damit Auto-Reconnect in calliope.serial.js greift
          window.CalliopeSerial?.expectReset?.(20000);

          if (window.CalliopeSerial?.saveHexToDrive) {
            await CalliopeSerial.saveHexToDrive(hexText, 'main.hex');
          } else {
            // Fallback: Download; User kopiert manuell ‚Üí Reset kommt sp√§ter
            const blob = new Blob([hexText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'main.hex';
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(() => URL.revokeObjectURL(a.href), 4000);
            document.getElementById('output')?.insertAdjacentHTML(
              'beforeend',
              `<div class="text-muted">‚ÑπÔ∏è HEX heruntergeladen. Nach dem Kopieren aufs Calliope-Laufwerk startet das Ger√§t neu.</div>`
            );
          }
        } catch (e) {
          console.error(e);
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend', `<div class="text-danger">‚ùå ${e.message || e}</div>`
          );
        }
      };
    })();
  </script>
<!-- Bootstrap Bundle (mit Popper) ‚Äì robuster Loader -->
<script>
  (function loadBootstrapBundle() {
    function add(src, label) {
      var s = document.createElement('script');
      s.src = src;
      s.async = false;            // Reihenfolge garantieren
      s.onload  = function(){ console.log('[boot] OK:', label, 'typeof bootstrap =', typeof window.bootstrap); };
      s.onerror = function(){ console.warn('[boot] FAIL:', label); };
      document.head.appendChild(s);
      return s;
    }
    // 1) lokal (falls du sie ablegst unter vendor/bootstrap.bundle.min.js), sonst √ºberspringen
    // var local = add('vendor/bootstrap.bundle.min.js', 'local');
    // local.onerror = function () {

    // 2) CDN-Kette
    var a = add('https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'jsDelivr');
    a.onerror = function () {
      var b = add('https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js', 'cdnjs');
      b.onerror = function () {
        add('https://unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'unpkg');
      };
    };
    // }; // <- falls du die lokale Zeile oben aktivierst, diese Klammern/Kommentar beachten
  })();
</script>

<!-- danach DEIN Script -->
<script src="scripts.js" defer></script>
</body>

</html>