<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <title>net-schulbuch-python (Monaco + Pyodide + Turtle)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="styles.css" rel="stylesheet" />


</head>

<body>
  <!-- Topbar -->
  <nav class="navbar navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <span class="navbar-brand mb-0 h1">net-schulbuch-python</span>
      </div>

      <div class="run-icon-center d-flex align-items-center gap-2">
        <span class="run-icon" id="run-icon" title="Programm ausführen (Shift+Enter)">▶</span>
        <button id="emergency-reset-btn" class="btn btn-danger btn-sm" title="Notfall-Reset" type="button">🔄</button>

        <!-- NEU: direkt daneben -->
        <button id="connect-toggle-btn" class="btn btn-outline-secondary btn-sm hidden" type="button"
          title="Verbinden">🔌 Verbinden</button>

        <button id="flash-btn" class="btn btn-warning btn-sm hidden" type="button" title="Flash (main.hex auf Gerät)">⚡
          Flash</button>
      </div>

      <div class="d-flex gap-2">
        <button id="save-png-btn" class="btn btn-info btn-sm text-white" disabled type="button">📋 Bild
          kopieren</button>
        <!-- Clear-Dropdown -->
        <div class="dropdown" id="clear-dropdown">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="clear-dropdown-btn"
            aria-expanded="false">Löschen ▼</button>
          <div class="dropdown-menu" id="clear-dropdown-menu" role="menu">
            <a class="dropdown-item" href="#" id="clear-editor-btn" role="menuitem">Editor löschen</a>
            <a class="dropdown-item" href="#" id="clear-canvas-btn" role="menuitem">Leinwand löschen</a>
            <a class="dropdown-item" href="#" id="clear-output-btn" role="menuitem">Ausgabe löschen</a>
          </div>
        </div>

        <!-- Hamburger-Menü -->
        <div class="dropdown" id="hamburger-dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="hamburger-btn"
            data-bs-toggle="dropdown" aria-expanded="false">☰</button>

          <div class="dropdown-menu dropdown-menu-end" id="hamburger-menu" role="menu" style="min-width:240px;"
            aria-labelledby="hamburger-btn">
            <a class="dropdown-item" href="#" id="load-program-btn" role="menuitem">Programm laden</a>
            <a class="dropdown-item" href="#" id="save-program-btn" role="menuitem">Programm speichern</a>

            <!-- Modal-Trigger bleibt so: -->
            <a class="dropdown-item" href="#" id="examples-btn" role="menuitem" data-bs-toggle="modal"
              data-bs-target="#examplesModal">📚 Beispiele</a>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Dateien</div>
            <label for="file-input" class="dropdown-item" style="cursor:pointer;">
              <input id="file-input" type="file" class="visually-hidden" multiple />
              📁 Dateien hochladen
            </label>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Layout</div>
            <div class="px-3 py-2">
              <select id="layout-select" class="form-select form-select-sm">
                <option value="canvas-output" selected>Canvas + Output</option>
                <option value="output-files">Output + Dateien</option>
                <option value="canvas-output-files">Canvas + Output + Dateien</option>
              </select>
            </div>

            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Hardware</div>
            <div class="px-3 py-2">
              <select id="device-select" class="form-select form-select-sm">
                <option value="none" selected>-</option>
                <option value="c12">Calliope mini 1/2</option>
                <option value="c3">Calliope mini 3</option>
              </select>
            </div>

            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" id="licenses-btn" role="menuitem">📄 Lizenzen</a>
            <a class="dropdown-item" href="#" id="impressum-btn" role="menuitem">🏢 Impressum</a>
          </div>
        </div>
  </nav>

  <!-- Hauptbereich -->
  <div id="workarea">
    <div id="left">
      <div id="editor"></div>
    </div>
    <div id="resizer" role="separator" aria-orientation="vertical" aria-label="Größenanpassung"></div>
    <div id="right">
      <div id="canvas-wrap"><canvas id="canvas" width="900" height="540"></canvas></div>
      <div id="resizer-h" role="separator" aria-orientation="horizontal" aria-label="Größenanpassung"></div>
      <div id="output"></div>
      <div id="files-panel" style="display:none;">
        <div class="p-3">
          <h6>Hochgeladene Dateien:</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Pfad</th>
                <th class="text-end">Größe</th>
                <th>Typ</th>
                <th class="text-center">Aktion</th>
              </tr>
            </thead>
            <tbody id="files-tbody">
              <tr>
                <td colspan="4"><em>Lade...</em></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal für Beispiele -->
  <div class="modal fade" id="examplesModal" tabindex="-1" aria-labelledby="examplesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="examplesModalLabel">📚 Turtle-Beispiele</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row" id="examples-grid">
            <!-- Beispiele werden hier dynamisch eingefügt -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
          <button type="button" class="btn btn-primary" id="load-example-btn" disabled>Programm laden</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal für Lizenzen -->
  <div class="modal fade" id="licensesModal" tabindex="-1" aria-labelledby="licensesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="licensesModalLabel">📄 Lizenzen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="license-section mb-4">
            <h6>🎯 net-schulbuch-python IDE</h6>
            <p><strong>Lizenz:</strong> Für nichtkommerzielle Zwecke kostenlos nutzbar</p>
            <p><strong>Entwickler:</strong> Klaus Dingemann</p>
            <p><strong>Beschreibung:</strong> Eine browserbasierte Python-IDE mit Turtle-Grafik, entwickelt für den
              Schulunterricht.</p>
          </div>

          <div class="license-section mb-4">
            <h6>🐍 Python</h6>
            <p><strong>Lizenz:</strong> Python Software Foundation License (PSF)</p>
            <p><strong>Website:</strong> <a href="https://www.python.org/" target="_blank">https://www.python.org/</a>
            </p>
            <p><strong>Beschreibung:</strong> Python ist eine Programmiersprache, die in dieser IDE über Pyodide
              ausgeführt wird.</p>
          </div>

          <div class="license-section mb-4">
            <h6>⚡ Pyodide</h6>
            <p><strong>Lizenz:</strong> Mozilla Public License 2.0 (MPL 2.0)</p>
            <p><strong>Website:</strong> <a href="https://pyodide.org/" target="_blank">https://pyodide.org/</a></p>
            <p><strong>Beschreibung:</strong> Pyodide ist eine Python-Distribution für den Browser, die CPython zu
              WebAssembly kompiliert.</p>
          </div>

          <div class="license-section mb-4">
            <h6>📝 Monaco Editor</h6>
            <p><strong>Lizenz:</strong> MIT License</p>
            <p><strong>Website:</strong> <a href="https://microsoft.github.io/monaco-editor/"
                target="_blank">https://microsoft.github.io/monaco-editor/</a></p>
            <p><strong>Beschreibung:</strong> Monaco Editor ist der Code-Editor, der in Visual Studio Code verwendet
              wird.</p>
          </div>

          <div class="license-section mb-4">
            <h6>🎨 Bootstrap</h6>
            <p><strong>Lizenz:</strong> MIT License</p>
            <p><strong>Website:</strong> <a href="https://getbootstrap.com/"
                target="_blank">https://getbootstrap.com/</a></p>
            <p><strong>Beschreibung:</strong> Bootstrap ist ein CSS-Framework für responsive Webdesign.</p>
          </div>

          <div class="license-section mb-4">
            <h6>📊 Python-Bibliotheken</h6>
            <p><strong>pandas:</strong> BSD 3-Clause License</p>
            <p><strong>numpy:</strong> BSD 3-Clause License</p>
            <p><strong>matplotlib:</strong> Python Software Foundation License (PSF)</p>
            <p><strong>micropip:</strong> Mozilla Public License 2.0 (MPL 2.0)</p>
            <p><strong>Beschreibung:</strong> Diese Bibliotheken werden über Pyodide geladen und sind für die
              Datenverarbeitung und Visualisierung verfügbar.</p>
          </div>

          <div class="license-section mb-4">
            <h6>🔒 Nutzungsbedingungen</h6>
            <p><strong>Nichtkommerzielle Nutzung:</strong> Diese Software darf für Bildungszwecke, private Projekte und
              nichtkommerzielle Anwendungen kostenlos genutzt werden.</p>
            <p><strong>Kommerzielle Nutzung:</strong> Für kommerzielle Zwecke ist eine separate Lizenzvereinbarung
              erforderlich.</p>
            <p><strong>Haftungsausschluss:</strong> Die Software wird "wie besehen" bereitgestellt, ohne Gewährleistung
              jeglicher Art.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal für Impressum -->
  <div class="modal fade" id="impressumModal" tabindex="-1" aria-labelledby="impressumModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="impressumModalLabel">🏢 Impressum</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="impressum-section mb-4">
            <h6>🏢 Unternehmensangaben</h6>
            <p><strong>Firmenname:</strong> net-schulbuch.de gemeinnützige UG (haftungsbeschränkt)</p>
            <p><strong>Adresse:</strong> Poststraße 38<br>49477 Ibbenbüren</p>
            <p><strong>Telefon:</strong> <a href="tel:+491712672373">+49 171 267 23 73</a></p>
            <p><strong>E-Mail:</strong> <a href="mailto:info@net-schulbuch.de">info@net-schulbuch.de</a></p>
            <p><strong>Internet:</strong> <a href="https://www.net-schulbuch.de"
                target="_blank">www.net-schulbuch.de</a></p>
          </div>

          <div class="impressum-section mb-4">
            <h6>📋 Rechtsform</h6>
            <p>NET-Schulbuch.de ist eine gemeinnützige Unternehmergesellschaft - gUG (haftungsbeschränkt) nach dem GmbHG
              vom 1. November 2008</p>
            <p><strong>Geschäftsführer der Gesellschaft ist Berthold Hufnagel</strong><br>
              E-Mail: <a href="mailto:hufnagel@net-schulbuch.de">hufnagel@net-schulbuch.de</a></p>
          </div>

          <div class="impressum-section mb-4">
            <h6>🐛 Fehlermeldungen</h6>
            <p>Fehlermeldungen bitte an: <a href="mailto:klaus@dingemann.de">klaus@dingemann.de</a></p>
          </div>

          <div class="impressum-section mb-4">
            <h6>📚 Unsere digitalen Schulbücher</h6>
            <p>Wir empfehlen unsere digitalen Schulbücher für den Mathematik- und Informatikunterricht:</p>
            <ul>
              <li><strong>Informatik 5/6</strong> (als Schulbuch in NRW genehmigt) - <a
                  href="https://if56.net-schulbuch.de" target="_blank">https://if56.net-schulbuch.de</a></li>
              <li><strong>Informatik S I</strong> - <a href="https://if2.net-schulbuch.de"
                  target="_blank">https://if2.net-schulbuch.de</a></li>
              <li><strong>Mathematik S I</strong> - <a href="https://m2.net-schulbuch.de"
                  target="_blank">https://m2.net-schulbuch.de</a></li>
              <li><strong>Informatik S I Wahlpflichtbereich</strong> - <a href="https://ifwp.net-schulbuch.de"
                  target="_blank">https://ifwp.net-schulbuch.de</a></li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS -->
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>-->
  <script>
    (function loadBootstrapBundle() {
      function add(src, label) {
        var s = document.createElement('script');
        s.src = src;
        s.async = false;            // Reihenfolge garantieren
        s.onload = function () { console.log('[boot] OK:', label, 'typeof bootstrap =', typeof window.bootstrap); };
        s.onerror = function () { console.warn('[boot] FAIL:', label); };
        document.head.appendChild(s);
        return s;
      }
      // 1) lokal (falls du sie ablegst unter vendor/bootstrap.bundle.min.js), sonst überspringen
      // var local = add('vendor/bootstrap.bundle.min.js', 'local');
      // local.onerror = function () {

      // 2) CDN-Kette
      var a = add('https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'jsDelivr');
      a.onerror = function () {
        var b = add('https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js', 'cdnjs');
        b.onerror = function () {
          add('https://unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'unpkg');
        };
      };
      // }; // <- falls du die lokale Zeile oben aktivierst, diese Klammern/Kommentar beachten
    })();
  </script>
  <!-- Monaco + Pyodide + Turtle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
  <script>
    // Monaco Editor initialisieren
    require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs" } });
    require(["vs/editor/editor.main"], function () {
      const startCode = sessionStorage.getItem('pythonide-editor-content') || "";
      window.editor = monaco.editor.create(document.getElementById("editor"), {
        value: startCode,
        language: "python",
        theme: "vs",
        automaticLayout: true,
        fontSize: 14
      });
      console.log("Monaco Editor erfolgreich initialisiert");
    });
  </script>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
  <script src="turtle.js"></script>
  <!-- micro:bit Tools – erst lokal, dann Fallback CDN (nur UMD der FS-Lib) -->
  <script src="vendor/microbit-fs/dist/microbit-fs.umd.js"></script>
  <script>
    (function () {
      // UMD kann unter MicrobitFs, microbit-fs oder als default exportiert sein
      var c = window.MicrobitFs || window.microbitFs || window['microbit-fs'] || null;
      if (c && c.default) c = c.default;
      if (c) {
        window.MicrobitFs = c;  // <- von calliope.hex.js benutzt
        window.microbitFs = c;  // zusätzlicher Alias
      } else {
        console.error('microbit-fs UMD nicht geladen – Pfad prüfen.');
      }
    })();
  </script>

  <!-- DAPjs für WebUSB Flash -->
  <script type="module">
    // DAPjs als ES-Modul laden
    import * as DAPjs from 'https://cdn.skypack.dev/dapjs@2.2.0';
    
    // Globale Variablen setzen
    window.DAPjs = DAPjs;
    window.DAPLink = DAPjs.DAPLink;
    window.WebUSB = DAPjs.WebUSB;
    window.CortexM = DAPjs.CortexM;
    
    console.log('DAPjs erfolgreich geladen:', DAPjs);
  </script>

  <!-- Calliope HEX Tools (ES-Modul, setzt zusätzlich window.calliopeHexTools) -->
  <script type="module" src="calliope-hex-tools.js"></script>



  <!-- Calliope Builder & Serial -->

  <script src="calliope.serial.js"></script>
  <script src="calliope.hex.js"></script>

  <script>
    (function topbarButtons() {
      const outEl = document.getElementById('output');
      const connectBtn = document.getElementById('connect-toggle-btn');
      const flashBtn = document.getElementById('flash-btn');
      if (!connectBtn || !flashBtn) return;

      const log = (m, cls = 'text-muted') => {
        outEl?.insertAdjacentHTML('beforeend', `<div class="${cls}">${m}</div>`);
        outEl?.scrollTo?.(0, outEl.scrollHeight);
      };

      let connected = false;
      function updateConnectUI() {
        connected = !!window.CalliopeSerial?.isOpen?.();
        if (connected) {
          connectBtn.classList.remove('btn-outline-secondary');
          connectBtn.classList.add('btn-success');
          connectBtn.textContent = '🟢 Trennen';
          connectBtn.title = 'Verbindung trennen';
        } else {
          connectBtn.classList.remove('btn-success');
          connectBtn.classList.add('btn-outline-secondary');
          connectBtn.textContent = '🔌 Verbinden';
          connectBtn.title = 'Mit Calliope verbinden';
        }
      }

      // Verbinden/Trennen (einziger Handler!)
      connectBtn.addEventListener('click', async () => {
        if (!window.CalliopeSerial) { log('❌ CalliopeSerial nicht geladen.', 'text-danger'); return; }
        connectBtn.disabled = true;            // gegen Doppel-Klicks
        try {
          if (!window.CalliopeSerial.isOpen()) {
            await CalliopeSerial.openSerial();
          } else {
            await CalliopeSerial.closeSerial();
          }
        } catch (e) {
          log(`❌ ${e?.message || e}`, 'text-danger');
        } finally {
          updateConnectUI();
          connectBtn.disabled = false;
        }
      });

      // System-Events halten den Button-Status synchron
      navigator.serial?.addEventListener?.('disconnect', () => updateConnectUI());
      navigator.serial?.addEventListener?.('connect', () => updateConnectUI());


      // --- global: Hardware-Ziel bestimmen ---
      function resolveTarget() {
        const sel = document.getElementById('device-select');
        if (sel && (sel.value === 'c12' || sel.value === 'c3')) return sel.value;
        if (window.CalliopeHex?.getTarget) {
          const t = CalliopeHex.getTarget();
          if (t === 'c12' || t === 'c3') return t;
        }
        return 'c12'; // Fallback
      }


      // Flash-Button - requestDevice() SOFORT in der User-Geste
      flashBtn.addEventListener('click', async () => {
        try {
          const target = resolveTarget();

          if (target === 'c12') {
            await CalliopeHex.buildAndDownload();
            return;
          }
          if (target !== 'c3') {
            log('⚠️ Keine Hardware gewählt.', 'text-warning');
            return;
          }

                    // --- 1) Verwende die robuste WebUSB-Funktion aus calliope.hex.js
          await CalliopeHex.buildAndFlashWebUSB();

        } catch (e) {
          console.error(e);
          log(`❌ Flash: ${e?.message || e}`, 'text-danger');
        }
      });

      updateConnectUI();
    })();
  </script>

  <script>
    (function deviceSelector() {
      const sel = document.getElementById('device-select');
      const runIcon = document.getElementById('run-icon');
      const resetBtn = document.getElementById('emergency-reset-btn');
      const connectB = document.getElementById('connect-toggle-btn');
      const flashB = document.getElementById('flash-btn');
      const badge = document.getElementById('calliope-target');

      if (!sel || !runIcon || !resetBtn || !connectB || !flashB) return;

      // Storage Helpers
      const LS_KEY_DEVICE = 'ui.device';
      const saveDevice = (v) => { try { localStorage.setItem(LS_KEY_DEVICE, v); } catch { } };
      const loadDevice = () => { try { return localStorage.getItem(LS_KEY_DEVICE) || null; } catch { return null; } };

      function applyUIByDevice(dev) {
        const hwSelected = (dev === 'c12' || dev === 'c3' || dev === 'microbit');

        connectB.classList.toggle('hidden', !hwSelected);
        flashB.classList.toggle('hidden', !hwSelected);

        // Run/Reset sperren, wenn Hardware
        runIcon.classList.toggle('disabled', hwSelected);
        if (hwSelected) {
          runIcon.setAttribute('aria-disabled', 'true');
          runIcon.title = 'Run im Browser deaktiviert (Hardware aktiv)';
          resetBtn.setAttribute('disabled', 'disabled');
          resetBtn.title = 'Notfall-Reset (Browser) deaktiviert';
        } else {
          runIcon.removeAttribute('aria-disabled');
          runIcon.title = 'Programm ausführen (Shift+Enter)';
          resetBtn.removeAttribute('disabled');
          resetBtn.title = 'Notfall-Reset';
        }

        // Badge
        if (badge) {
          if (dev === 'c12') badge.textContent = '1/2';
          else if (dev === 'c3') badge.textContent = '3';
          else badge.textContent = '–';
        }

        // Target an Builder
        if (window.CalliopeHex) {
          if (dev === 'c12' && CalliopeHex.setTargetC12) CalliopeHex.setTargetC12();
          if (dev === 'c3' && CalliopeHex.setTargetC3) CalliopeHex.setTargetC3();
        }
      }

      // Auswahlwechsel speichern + anwenden
      sel.addEventListener('change', () => {
        const dev = sel.value; // 'none' | 'c12' | 'c3' | 'microbit'
        saveDevice(dev);
        applyUIByDevice(dev);
      });

      // Beim Laden gespeichertes Gerät wiederherstellen
      (function restoreDeviceOnLoad() {
        const saved = loadDevice();
        if (saved && [...sel.options].some(o => o.value === saved)) {
          sel.value = saved;
        }
        saveDevice(sel.value);
        applyUIByDevice(sel.value);
      })();

      // ❌ KEIN zusätzlicher Click-Handler für connectB hier!
      // ❌ KEIN zweiter connected-State hier!
    })();
  </script>

  <script>
    // Editor-Inhalt robust abholen (Textarea / Monaco / CodeMirror)
    function getEditorCode() {
      try { if (window.editor?.getValue) return String(window.editor.getValue()); } catch (e) { }
      try { if (window.cmEditor?.getValue) return String(window.cmEditor.getValue()); } catch (e) { }
      const ta = document.querySelector('#editor, textarea[name="code"], textarea[data-role="editor"]');
      return ta ? String(ta.value || '') : '';
    }

    // -------- Serielle Verbindung initialisieren + Buttons verdrahten --------
    (function initSerial() {
      if (!window.CalliopeSerial) { setTimeout(initSerial, 80); return; }

      CalliopeSerial.init({
        editor: { getValue: getEditorCode },
        outEl: document.getElementById('output')
      });

      // 🔌 Verbinden (Event-Listener entfernt - wird über connectBtn gehandhabt)
      // ❌ Trennen (Event-Listener entfernt - wird über connectBtn gehandhabt)

      // ⬆️ Upload (main.py) + sichtbar ausführen
      document.getElementById('btn-serial-upload')?.addEventListener('click', async (e) => {
        e.preventDefault();
        const code = getEditorCode();
        if (!/\S/.test(code)) { alert('Kein Code im Editor.'); return; }
        try { await CalliopeSerial.uploadMainPyViaSerial(code); }
        catch (err) { console.error('Upload fehlgeschlagen:', err); }
      });
    })();

    // -------- HEX-Builder initialisieren – fester Pfad in /firmware --------


    (function initCalliopeHex() {
      if (!window.CalliopeHex) { setTimeout(initCalliopeHex, 80); return; }

      const urls = {
        c12: 'firmware/calliope12-micropython.hex', // Calliope Mini 1/2
        c3: 'firmware/calliope-v3-correct.hex'    // Calliope Mini 3 (richtige Firmware)
      };

      // Hilfsfunktion: Datei testen
      async function checkUrl(url) {
        try {
          const r = await fetch(url, { method: 'GET', cache: 'no-store' });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return true;
        } catch (e) {
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend',
            `<div class="text-danger">❌ Firmware nicht erreichbar: ${url} (${e.message || e})</div>`
          );
          console.error('Firmware fehlt:', url, e);
          return false;
        }
      }

      (async () => {
        const ok12 = await checkUrl(urls.c12);
        const ok3 = await checkUrl(urls.c3);

        if (!ok12 && !ok3) {
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend',
            `<div class="text-danger">❌ Weder Calliope V1/V2 noch V3 Firmware gefunden – bitte /firmware prüfen!</div>`
          );
          return; // gar nicht initialisieren
        }

        CalliopeHex.init({
          outEl: document.getElementById('output'),
          firmwareUrls: urls
        });
      })();
    })();


    // -------- Builder-Hook: Editor → HEX + Flash mit expectReset --------
    (function hookHexBuilder() {
      if (!window.calliopeHexTools || !window.CalliopeHex) {
        return void setTimeout(hookHexBuilder, 80);
      }

      // Firmware je nach Ziel laden
      async function fetchBaseHex() {
        const urls = CalliopeHex.firmwareUrls || { c12: 'firmware/micro_bit.hex' };
        const target = (CalliopeHex.getTarget && CalliopeHex.getTarget()) || 'c12';
        const url = (target === 'c3' && urls.c3) ? urls.c3 : urls.c12;
        if (!url) throw new Error('Keine Firmware-URL für aktuelles Ziel.');
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Firmware nicht ladbar: ${url}`);
        return await res.text();
      }

      // Editor → HEX-Text
      async function buildHexText() {
        const baseHex = await fetchBaseHex();
        const py = getEditorCode();
        if (!/\S/.test(py)) throw new Error('Kein Python-Code im Editor.');
        // Für C1/2 klassisch anhängen; für C3 könnte später FS genutzt werden:
        const target = (CalliopeHex.getTarget && CalliopeHex.getTarget()) || 'c12';
        return (target === 'c3')
          ? await calliopeHexTools.packMainPyAuto(baseHex, py, { quiet: true })
          : calliopeHexTools.appendScriptV1(baseHex, py);
      }
      
      // Exportiere buildHexText für den Flash-Handler
      CalliopeHex._buildHexText = buildHexText;

      // ⬇️ Download (kein Reset nötig)
      CalliopeHex.buildAndDownload = async function () {
        try {
          const hexText = await buildHexText();
          const blob = new Blob([hexText], { type: 'text/plain' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'main.hex';
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(() => URL.revokeObjectURL(a.href), 4000);
        } catch (e) {
          console.error(e);
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend', `<div class="text-danger">❌ ${e.message || e}</div>`
          );
        }
      };

      // 💽 Aufs Laufwerk (oder Fallback Download) — hier Reset ankündigen
      CalliopeHex.buildAndSaveToDrive = async function () {
        try {
          const hexText = await buildHexText();

          // 👉 Neustart-Fenster ankündigen, damit Auto-Reconnect in calliope.serial.js greift
          window.CalliopeSerial?.expectReset?.(20000);

          if (window.CalliopeSerial?.saveHexToDrive) {
            await CalliopeSerial.saveHexToDrive(hexText, 'main.hex');
          } else {
            // Fallback: Download; User kopiert manuell → Reset kommt später
            const blob = new Blob([hexText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'main.hex';
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(() => URL.revokeObjectURL(a.href), 4000);
            document.getElementById('output')?.insertAdjacentHTML(
              'beforeend',
              `<div class="text-muted">ℹ️ HEX heruntergeladen. Nach dem Kopieren aufs Calliope-Laufwerk startet das Gerät neu.</div>`
            );
          }
        } catch (e) {
          console.error(e);
          document.getElementById('output')?.insertAdjacentHTML(
            'beforeend', `<div class="text-danger">❌ ${e.message || e}</div>`
          );
        }
      };
    })();
  </script>
  <!-- Bootstrap Bundle (mit Popper) – robuster Loader -->
  <script>
    (function loadBootstrapBundle() {
      function add(src, label) {
        var s = document.createElement('script');
        s.src = src;
        s.async = false;            // Reihenfolge garantieren
        s.onload = function () { console.log('[boot] OK:', label, 'typeof bootstrap =', typeof window.bootstrap); };
        s.onerror = function () { console.warn('[boot] FAIL:', label); };
        document.head.appendChild(s);
        return s;
      }
      // 1) lokal (falls du sie ablegst unter vendor/bootstrap.bundle.min.js), sonst überspringen
      // var local = add('vendor/bootstrap.bundle.min.js', 'local');
      // local.onerror = function () {

      // 2) CDN-Kette
      var a = add('https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'jsDelivr');
      a.onerror = function () {
        var b = add('https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js', 'cdnjs');
        b.onerror = function () {
          add('https://unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'unpkg');
        };
      };
      // }; // <- falls du die lokale Zeile oben aktivierst, diese Klammern/Kommentar beachten
    })();
  </script>

  <!-- danach DEIN Script -->
  <script src="scripts.js" defer></script>
</body>

</html>